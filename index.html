<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Drive2Map</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <link rel="stylesheet" href="css/app.css">

</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div id="map"></div>

  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="js/leaflet.geocsv.js"></script>
  <script>

  var map = L.map('map', {attributionControl:false}).setView([-23.5552, -46.6129], 13);
  L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  	maxZoom: 18
  }).addTo(map);

  $.ajax ({
  	type:'GET',
  	url:'https://spreadsheets.google.com/feeds/list/1ZQ_Tc7FGs6e9h6Fn-tNzqRQyIA6lUJMG_7h-IutjqPk/od6/public/values?alt=json',
     error: function(err) {
       console.log(err);
       alert('No se pudieron cargar los datos');
     },
  	success: function(data) {
      loadDataToMap(parse(data),map);
  	}
  });

  function loadDataToMap(data, map) {
    data.forEach(function(item){
      var marker = getMarker(item);
      marker.addTo(map);
    });
  }

  function getMarker(item){
    var marker = L.marker([item.lat, item.lon]);
    marker.bindPopup(getPopup(item));
    return marker;
  }

  function getPopup(item) {
    var table = '<table><tbody>';
    for(key in item) {
      table += '<tr><th>' + key + '</th><td>' + item[key] + '</td></tr>';
    }
    table += '</tbody></table>';
    return table;
  };

  function parse(data) {
    var entries = data.feed.entry;
		var parsed = [];
		var gdocsBase = 'gsx$';

		entries.forEach(function(entry) {

      var item = {};
      Object.keys(entry).forEach( function(key){
        if (key.indexOf('gsx$') !== -1) {
          item[key.replace('gsx$', '')] = entry[key]['$t'];
        }
      });
      if (item.lat && item.lon) parsed.push(item);
    });

    return parsed;

  }

	</script>


<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
